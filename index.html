<!DOCTYPE html>
<html lang="ar" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fahim Afandi - فهيم أفندي</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <!-- New Libraries for ZIP and Files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        primary: '#1e40af', // Blue 800
                        secondary: '#0f172a', // Slate 900
                        accent: '#d97706', // Amber 600
                        darkbg: '#020617', // Very dark slate
                        darkcard: '#1e293b', // Slate 800
                        electric: '#06b6d4', // Cyan 500
                        research: '#7c3aed', // Violet 600 for Research Mode
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Loader */
        .loader {
            width: 48px; height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #1e40af;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Resizer Handle */
        .gutter {
            background-color: #e2e8f0;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjMyIiB2aWV3Qm94PSIwIDAgOCAzMiI+PHBhdGggZmlsbD0iTTAgMGgydjMySDB6bTQgMGgydjMySDR6Ii8+PC9zdmc+');
            background-repeat: no-repeat;
            background-position: center;
            cursor: col-resize;
            transition: background-color 0.2s;
        }
        .gutter:hover, .gutter:active { background-color: #3b82f6; }
        .dark .gutter { background-color: #1e293b; }
        .dark .gutter:hover { background-color: #3b82f6; }

        /* Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Panel Transition Class */
        .panel-closed {
            flex: 0 0 0% !important;
            min-width: 0 !important;
            width: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
            border: none !important;
        }

        /* Glow Animation for Title */
        @keyframes text-glow {
            0%, 100% { text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
            50% { text-shadow: 0 0 20px rgba(6, 182, 212, 0.8); }
        }
        .animate-title-glow { animation: text-glow 3s ease-in-out infinite; }

        /* Brain Pulse */
        @keyframes brain-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .animate-brain { animation: brain-pulse 3s infinite; }
        
        /* Tab Active State */
        .tab-active {
            border-bottom: 3px solid;
            color: inherit;
        }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-200 bg-slate-50 dark:bg-darkbg h-screen flex flex-col overflow-hidden transition-colors duration-300">

    <!-- Navbar -->
    <nav class="bg-white dark:bg-secondary border-b border-slate-200 dark:border-slate-800 h-16 shrink-0 z-50 transition-colors duration-300">
        <div class="max-w-full px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="goHome()" title="الرئيسية">
                <div class="flex flex-col items-center">
                    <div class="flex items-center gap-2">
                        <div class="bg-primary text-white w-8 h-8 rounded-lg flex items-center justify-center shadow-lg shadow-blue-900/20">
                            <i class="fa-solid fa-book-open text-sm"></i>
                        </div>
                        <span class="text-xl font-extrabold text-primary dark:text-blue-400 leading-none">فَهِيم</span>
                    </div>
                    <span class="text-[10px] font-bold text-slate-500 dark:text-slate-400 mt-1">Omar AL-imam</span>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="toggleOfflineFiles()" class="w-10 h-10 rounded-full bg-amber-50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-400 hover:bg-amber-100 transition-all" title="الملفات المحفوظة">
                    <i class="fa-solid fa-folder-open"></i>
                </button>
                <button onclick="togglePdfViewer()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:text-primary transition-all" title="إظهار/إخفاء المستند">
                    <i class="fa-solid fa-columns"></i>
                </button>
                <button onclick="goHome()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:text-primary transition-all" title="الرئيسية">
                    <i class="fa-solid fa-house"></i>
                </button>
                <button id="themeToggle" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 transition-all">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:inline"></i>
                </button>
                <button onclick="document.getElementById('settingsModal').classList.remove('hidden')" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:text-primary transition-all">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
        
        <!-- Left Panel: PDF Viewer -->
        <div id="leftPanel" class="flex-1 flex flex-col bg-slate-200 dark:bg-black/20 min-w-[300px] h-full relative border-l border-slate-300 dark:border-slate-700 order-2 md:order-1 transition-all duration-300 ease-in-out">
            <div id="pdfToolbar" class="bg-white dark:bg-secondary border-b border-slate-200 dark:border-slate-800 p-2 flex justify-between items-center hidden">
                <div class="flex items-center gap-2">
                    <button onclick="prevPage()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded"><i class="fa-solid fa-chevron-right"></i></button>
                    <span id="pageInfo" class="text-sm font-mono">0 / 0</span>
                    <button onclick="nextPage()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded"><i class="fa-solid fa-chevron-left"></i></button>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="zoomOut()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded"><i class="fa-solid fa-minus"></i></button>
                    <span id="zoomLevel" class="text-xs font-mono">100%</span>
                    <button onclick="zoomIn()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
            <div id="pdfContainer" class="flex-1 overflow-auto flex justify-center p-4">
                <div id="uploadPlaceholder" class="flex flex-col items-center justify-center h-full text-center">
                    <div class="w-24 h-24 bg-blue-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-primary dark:text-blue-400 mb-4 animate-bounce-slow">
                        <i class="fa-regular fa-file-pdf text-4xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-700 dark:text-slate-200">عارض المستندات</h3>
                    <p class="text-slate-500 dark:text-slate-400 text-sm">سيظهر الملف هنا بعد الرفع</p>
                </div>
                <canvas id="the-canvas" class="shadow-2xl hidden"></canvas>
            </div>
        </div>

        <!-- Resizer -->
        <div id="resizer" class="w-2 h-full gutter hidden md:block z-20 order-1 md:order-2 transition-opacity duration-300"></div>

        <!-- Right Panel: Content -->
        <div id="rightPanel" class="flex-1 flex flex-col bg-slate-50 dark:bg-darkbg min-w-[350px] h-full overflow-hidden order-1 md:order-3 relative">
            <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth custom-scrollbar relative" id="analysisContent">
                
                <!-- Main Header & Tabs -->
                <div class="max-w-xl mx-auto text-center pt-8 pb-4 fade-in">
                    <div class="mb-8 animate-fade-in-up">
                        <h1 class="text-5xl md:text-6xl font-extrabold text-primary dark:text-blue-400 mb-4 tracking-tight animate-title-glow flex items-center justify-center gap-4 flex-wrap">
                            فهيم أفندي 
                            <span class="text-electric text-4xl md:text-5xl inline-block animate-brain"><i class="fa-solid fa-brain"></i></span>
                        </h1>
                        <p class="text-xs md:text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-[0.3em]">Project by Omar Al-imam</p>
                    </div>

                    <!-- Mode Switcher Tabs -->
                    <div class="flex justify-center gap-6 mb-8 border-b border-slate-200 dark:border-slate-700">
                        <button onclick="switchMode('book')" id="tabBook" class="pb-3 text-lg font-bold text-primary border-primary tab-active transition-all flex items-center gap-2">
                            <i class="fa-solid fa-file-pdf"></i> تحليل الكتب
                        </button>
                        <button onclick="switchMode('research')" id="tabResearch" class="pb-3 text-lg font-bold text-slate-400 border-transparent hover:text-research transition-all flex items-center gap-2">
                            <i class="fa-solid fa-magnifying-glass"></i> بحث AI
                        </button>
                    </div>
                </div>

                <!-- 1. Book Upload View -->
                <section id="modeBook" class="max-w-xl mx-auto text-center fade-in">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-secondary dark:text-white mb-2 leading-tight">حلل كتبك <span class="text-primary dark:text-blue-400">بذكاء</span></h2>
                        <p class="text-slate-500 dark:text-slate-400">ارفع ملف PDF واحصل على تحليل شامل فوري.</p>
                        <!-- Language Indicator -->
                        <div id="langIndicator" class="mt-4 hidden">
                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300">
                                <i class="fa-solid fa-language mr-1"></i> Detected: <span id="detectedLang">...</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="glass rounded-3xl p-10 border-2 border-dashed border-slate-300 dark:border-slate-700 hover:border-primary dark:hover:border-blue-500 transition-all duration-300 relative group">
                        <input type="file" id="fileInput" accept=".pdf,.txt" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                        <div class="flex flex-col items-center gap-4 group-hover:scale-105 transition-transform duration-300">
                            <div class="w-16 h-16 bg-blue-50 dark:bg-slate-800 rounded-2xl flex items-center justify-center text-primary dark:text-blue-400 shadow-sm">
                                <i class="fa-solid fa-cloud-arrow-up text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200" id="fileName">اختر ملف PDF</h3>
                                <p class="text-xs text-slate-400 mt-1">يتم الكشف عن اللغة تلقائياً</p>
                            </div>
                        </div>
                    </div>
                    <button id="startBtn" onclick="startAnalysis()" class="hidden mt-8 w-full bg-primary hover:bg-blue-800 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-900/20 transition-all">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> ابدأ التحليل
                    </button>
                </section>

                <!-- 2. Research View (New Feature) -->
                <section id="modeResearch" class="max-w-xl mx-auto text-center fade-in hidden">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-secondary dark:text-white mb-2 leading-tight">محرر بحث <span class="text-research dark:text-violet-400">بالذكاء الاصطناعي</span></h2>
                        <p class="text-slate-500 dark:text-slate-400">اكتب أي موضوع واحصل على بحث شامل فوراً.</p>
                    </div>

                    <div class="glass rounded-3xl p-6 border border-slate-200 dark:border-slate-700 shadow-lg text-left">
                        <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">موضوع البحث</label>
                        <textarea id="researchInput" rows="3" placeholder="مثال: أسباب سقوط الدولة العباسية، Climate Change, Artificial Intelligence..." class="w-full p-4 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-2 focus:ring-research focus:border-transparent outline-none transition-all resize-none"></textarea>
                        
                        <button onclick="startResearch()" class="mt-4 w-full bg-research hover:bg-violet-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-violet-900/20 transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-microchip"></i> Generate Summary
                        </button>
                    </div>
                </section>

                <!-- Results Dashboard (Book) -->
                <div id="resultsDashboard" class="hidden space-y-8 pb-20">
                    <!-- Actions Toolbar -->
                    <div class="flex justify-between items-center bg-white dark:bg-secondary p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <span class="text-sm font-bold text-primary dark:text-blue-400" id="resultTitle">نتائج التحليل</span>
                        <div class="flex gap-2">
                            <button onclick="downloadAllZip()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg font-bold transition-all">
                                <i class="fa-solid fa-file-zipper"></i> تحميل الكل (ZIP)
                            </button>
                        </div>
                    </div>

                    <!-- 1. Summary -->
                    <div class="glass rounded-2xl p-6 border-r-4 border-primary dark:border-blue-500">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-blue-100 dark:bg-blue-900/30 text-primary dark:text-blue-400 p-2 rounded-lg"><i class="fa-solid fa-align-left"></i></div>
                            <h2 class="text-xl font-bold text-secondary dark:text-white">Book Summary</h2>
                        </div>
                        <div id="summaryContent" class="prose prose-slate dark:prose-invert max-w-none leading-loose text-justify text-sm md:text-base"></div>
                    </div>

                    <!-- 2. Definitions -->
                    <div class="glass rounded-2xl p-6 border-r-4 border-accent">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-amber-100 dark:bg-amber-900/30 text-accent p-2 rounded-lg"><i class="fa-solid fa-key"></i></div>
                            <h2 class="text-xl font-bold text-secondary dark:text-white">Key Definitions</h2>
                        </div>
                        <div id="definitionsContent" class="grid gap-3"></div>
                    </div>

                    <!-- 3. Points -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 p-2 rounded-lg"><i class="fa-solid fa-check-double"></i></div>
                            <h2 class="text-xl font-bold text-secondary dark:text-white">Important Points</h2>
                        </div>
                        <ul id="pointsContent" class="space-y-3"></ul>
                    </div>

                    <!-- 4. Chapters -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 p-2 rounded-lg"><i class="fa-solid fa-list-ol"></i></div>
                            <h2 class="text-xl font-bold text-secondary dark:text-white">Chapter Breakdown</h2>
                        </div>
                        <div id="chaptersContent" class="space-y-4"></div>
                    </div>

                    <!-- 7. Headings Q&A -->
                    <div class="glass rounded-2xl p-6 border-l-4 border-teal-500">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="bg-teal-100 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400 p-2 rounded-lg"><i class="fa-solid fa-circle-question"></i></div>
                            <div>
                                <h2 class="text-xl font-bold text-secondary dark:text-white">Main Headings as Q&A</h2>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Concept Deep Dive</p>
                            </div>
                        </div>
                        <div id="headingsQaContent" class="space-y-6"></div>
                    </div>

                    <!-- 5. Mind Map -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 p-2 rounded-lg"><i class="fa-solid fa-sitemap"></i></div>
                            <h2 class="text-xl font-bold text-secondary dark:text-white">Mind Map</h2>
                        </div>
                        <div id="mindmapContainer" class="w-full overflow-x-auto bg-white dark:bg-slate-800 p-4 rounded-xl min-h-[200px] flex justify-center"></div>
                    </div>

                    <!-- 6. Audio -->
                    <div class="bg-secondary dark:bg-slate-800 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold mb-1">Audio Summary</h2>
                            <p class="text-slate-400 text-sm mb-4">Listen to the AI narrator</p>
                            
                            <div id="audioPlayerContainer" class="hidden mb-4">
                                <audio id="audioPlayer" controls class="w-full mb-2 h-10 rounded"></audio>
                            </div>

                            <button id="generateAudioBtn" onclick="generateAudio()" class="w-full bg-accent hover:bg-amber-700 text-white py-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2">
                                <i class="fa-solid fa-play"></i> Generate Audio
                            </button>
                            
                            <div class="mt-4 pt-4 border-t border-slate-700">
                                <p class="text-xs text-slate-500 uppercase font-bold mb-1">Script Preview</p>
                                <p id="audioScriptContent" class="text-xs text-slate-300 font-mono leading-relaxed line-clamp-3"></p>
                            </div>
                        </div>
                    </div>

                    <!-- 7. Quiz -->
                    <div class="glass rounded-2xl p-6 border-t-4 border-red-500">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 p-2 rounded-lg"><i class="fa-solid fa-graduation-cap"></i></div>
                            <h2 class="text-xl font-bold text-secondary dark:text-white">Book Exam</h2>
                        </div>
                        <div id="quizContent" class="space-y-6"></div>
                        <button onclick="checkQuiz()" class="mt-6 w-full bg-secondary dark:bg-black text-white py-3 rounded-xl font-bold hover:bg-slate-800">Check Answers</button>
                    </div>
                </div>

                <!-- Research Results Dashboard (New) -->
                <div id="researchResultsDashboard" class="hidden space-y-8 pb-20">
                    <div class="glass rounded-2xl p-6 border-l-4 border-research shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-violet-100 dark:bg-violet-900/30 text-research dark:text-violet-400 p-2 rounded-lg"><i class="fa-solid fa-microscope"></i></div>
                            <h2 class="text-xl font-bold text-secondary dark:text-white">Topic Summary</h2>
                        </div>
                        <div id="resSummary" class="prose prose-slate dark:prose-invert max-w-none leading-loose text-justify text-sm md:text-base"></div>
                    </div>

                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 p-2 rounded-lg"><i class="fa-solid fa-list-check"></i></div>
                            <h2 class="text-xl font-bold text-secondary dark:text-white">Key Points</h2>
                        </div>
                        <ul id="resPoints" class="space-y-3"></ul>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="glass rounded-2xl p-6">
                            <h3 class="font-bold text-lg mb-4 text-accent dark:text-amber-400"><i class="fa-solid fa-book-atlas"></i> Definitions</h3>
                            <div id="resDefinitions" class="space-y-3"></div>
                        </div>
                        <div class="glass rounded-2xl p-6">
                            <h3 class="font-bold text-lg mb-4 text-indigo-600 dark:text-indigo-400"><i class="fa-solid fa-project-diagram"></i> Concept Map</h3>
                            <div id="resMindMap" class="w-full overflow-x-auto"></div>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-6 border-l-4 border-electric">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="bg-cyan-100 dark:bg-cyan-900/30 text-electric dark:text-cyan-400 p-2 rounded-lg"><i class="fa-solid fa-layer-group"></i></div>
                            <h2 class="text-xl font-bold text-secondary dark:text-white">Deep Explanation</h2>
                        </div>
                        <div id="resDeepDive" class="prose prose-slate dark:prose-invert max-w-none"></div>
                    </div>

                    <div class="glass rounded-2xl p-6 border-t-4 border-research">
                        <h2 class="text-xl font-bold text-secondary dark:text-white mb-6">Knowledge Check</h2>
                        <div id="resQuiz" class="space-y-6"></div>
                    </div>
                </div>

            </div>

            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="absolute inset-0 bg-white/90 dark:bg-secondary/90 backdrop-blur-sm z-[60] hidden flex-col items-center justify-center text-center">
                <span class="loader mb-4"></span>
                <h3 class="text-xl font-bold text-primary dark:text-blue-400 mb-1">Working...</h3>
                <p id="loadingStep" class="text-sm text-slate-500 dark:text-slate-400 animate-pulse">Processing request</p>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-darkcard rounded-2xl p-6 w-full max-w-md shadow-2xl border border-slate-200 dark:border-slate-700 transition-colors duration-300">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Settings</h3>
                <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="text-slate-500 dark:text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="AIzaSy..." class="w-full p-3 border dark:border-slate-600 rounded-xl bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-white" />
                    <p class="text-xs text-slate-400 mt-1">Saved locally in your browser.</p>
                </div>
                <button onclick="saveSettings()" class="w-full bg-primary hover:bg-blue-800 text-white py-3 rounded-xl font-bold transition-all">Save & Close</button>
            </div>
        </div>
    </div>

    <!-- Offline Files Modal -->
    <div id="offlineFilesModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-darkcard rounded-2xl p-6 w-full max-w-2xl shadow-2xl border border-slate-200 dark:border-slate-700 transition-colors duration-300 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <i class="fa-solid fa-folder-open text-amber-500"></i> الملفات المحفوظة
                </h3>
                <button onclick="toggleOfflineFiles()" class="text-slate-500 dark:text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="savedFilesList" class="flex-1 overflow-y-auto space-y-3 custom-scrollbar p-1">
                <!-- File items injected here -->
                <p class="text-center text-slate-400 mt-10">لا توجد ملفات محفوظة بعد.</p>
            </div>
        </div>
    </div>

    <!-- MAIN LOGIC -->
    <script>
        // --- State Management ---
        let API_KEY = localStorage.getItem('faheem_api_key') || "";
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.0;
        let canvas = document.getElementById('the-canvas');
        let ctx = canvas.getContext('2d');
        
        // Data Store
        let currentAnalysis = null;
        let currentBookTitle = "Untitled";
        let detectedLang = 'ar';
        let currentMode = 'book';

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initSplitter();
            if(API_KEY) document.getElementById('apiKeyInput').value = API_KEY;
            mermaid.initialize({ startOnLoad: false, theme: document.documentElement.classList.contains('dark') ? 'dark' : 'default', direction: 'rtl' });
        });

        // --- Mode Switching ---
        function switchMode(mode) {
            currentMode = mode;
            // Tabs UI
            if(mode === 'book') {
                document.getElementById('tabBook').classList.add('text-primary', 'border-primary', 'tab-active');
                document.getElementById('tabBook').classList.remove('text-slate-400', 'border-transparent');
                
                document.getElementById('tabResearch').classList.remove('text-research', 'border-research', 'tab-active');
                document.getElementById('tabResearch').classList.add('text-slate-400', 'border-transparent');
                
                document.getElementById('modeBook').classList.remove('hidden');
                document.getElementById('modeResearch').classList.add('hidden');
            } else {
                document.getElementById('tabResearch').classList.add('text-research', 'border-research', 'tab-active');
                document.getElementById('tabResearch').classList.remove('text-slate-400', 'border-transparent');
                
                document.getElementById('tabBook').classList.remove('text-primary', 'border-primary', 'tab-active');
                document.getElementById('tabBook').classList.add('text-slate-400', 'border-transparent');
                
                document.getElementById('modeResearch').classList.remove('hidden');
                document.getElementById('modeBook').classList.add('hidden');
            }
            
            // Hide results
            document.getElementById('resultsDashboard').classList.add('hidden');
            document.getElementById('researchResultsDashboard').classList.add('hidden');
        }

        // --- Language Detection ---
        function detectLanguage(text) {
            const arabicPattern = /[\u0600-\u06FF]/;
            const isArabic = arabicPattern.test(text.substring(0, 1000)); 
            detectedLang = isArabic ? 'ar' : 'en';
            
            // Update UI
            if(currentMode === 'book') {
                const indicator = document.getElementById('langIndicator');
                const langText = document.getElementById('detectedLang');
                indicator.classList.remove('hidden');
                langText.textContent = isArabic ? "Arabic (العربية)" : "English";
            }
            
            // Update direction
            document.documentElement.dir = isArabic ? 'rtl' : 'ltr';
            return isArabic;
        }

        // --- Research Logic ---
        async function startResearch() {
            if(!API_KEY) {
                document.getElementById('settingsModal').classList.remove('hidden');
                return;
            }
            const topic = document.getElementById('researchInput').value.trim();
            if(!topic) {
                alert("الرجاء كتابة موضوع البحث.");
                return;
            }

            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
            document.getElementById('modeResearch').classList.add('hidden');

            try {
                const isArabic = detectLanguage(topic);
                const langPrompt = isArabic ? "ARABIC" : "ENGLISH";

                const RESEARCH_PROMPT = `
                Act as "Fahim Afandi". Research the following topic: "${topic}".
                Language: ${langPrompt}.
                
                Return VALID JSON with this structure:
                {
                    "summary": "Detailed comprehensive summary",
                    "key_points": ["Point 1", "Point 2"],
                    "definitions": [{"term": "...", "definition": "..."}],
                    "deep_explanation": "Deep dive into subtopics with examples...",
                    "mind_map_mermaid": "graph TD; ...",
                    "quiz": [{"question": "...", "options": ["..."], "correct_index": 0}]
                }
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: RESEARCH_PROMPT }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                if(!data.candidates) throw new Error("API Error");
                
                const resultJSON = JSON.parse(data.candidates[0].content.parts[0].text);
                
                renderResearchResults(resultJSON);

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
                document.getElementById('modeResearch').classList.remove('hidden');
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
            }
        }

        function renderResearchResults(data) {
            const dashboard = document.getElementById('researchResultsDashboard');
            dashboard.classList.remove('hidden');

            document.getElementById('resSummary').textContent = data.summary;
            document.getElementById('resDeepDive').textContent = data.deep_explanation;

            document.getElementById('resPoints').innerHTML = data.key_points.map(p => `
                <li class="flex items-start gap-3 p-3 rounded-lg bg-white dark:bg-darkcard border border-slate-100 dark:border-slate-700">
                    <i class="fa-solid fa-check text-green-500 mt-1"></i>
                    <span class="text-slate-700 dark:text-slate-300">${p}</span>
                </li>
            `).join('');

            document.getElementById('resDefinitions').innerHTML = data.definitions.map(d => `
                <div class="bg-amber-50 dark:bg-amber-900/20 p-2 rounded border border-amber-100 dark:border-amber-800 text-sm">
                    <span class="font-bold text-accent dark:text-amber-400">${d.term}:</span>
                    <span class="text-slate-600 dark:text-slate-300">${d.definition}</span>
                </div>
            `).join('');

            const mermaidDiv = document.getElementById('resMindMap');
            mermaidDiv.innerHTML = `<div class="mermaid">${data.mind_map_mermaid}</div>`;
            mermaid.init(undefined, document.querySelectorAll('.mermaid'));

            document.getElementById('resQuiz').innerHTML = data.quiz.map((q, i) => `
                <div class="bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm quiz-card" data-correct="${q.correct_index}">
                    <p class="font-bold text-base mb-3 text-secondary dark:text-slate-200"><span class="text-red-500">Q${i+1}.</span> ${q.question}</p>
                    <div class="space-y-2">
                        ${q.options.map((opt, optIdx) => `
                            <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 dark:border-slate-600 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                <input type="radio" name="rq${i}" value="${optIdx}" class="w-4 h-4 text-research">
                                <span class="text-slate-700 dark:text-slate-300 text-sm">${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="feedback mt-2 hidden font-bold text-sm"></div>
                </div>
            `).join('');
        }

        // --- Offline Storage Logic ---
        function saveAnalysisLocally(data, title) {
            const fileId = 'fahim_' + Date.now();
            const record = {
                id: fileId,
                title: title,
                date: new Date().toLocaleDateString(),
                data: data,
                lang: detectedLang
            };
            
            // Try to save to localStorage (simple method for preview)
            try {
                // Check storage limit mechanism roughly
                const existing = JSON.parse(localStorage.getItem('fahim_files') || '[]');
                if(existing.length > 5) existing.pop(); // Keep last 5 to avoid quota error
                existing.unshift(record);
                localStorage.setItem('fahim_files', JSON.stringify(existing));
                alert("تم حفظ التحليل تلقائياً في الملفات المحفوظة.");
            } catch (e) {
                console.warn("Storage full or error:", e);
                alert("مساحة التخزين ممتلئة، لم يتم الحفظ المحلي.");
            }
        }

        function toggleOfflineFiles() {
            const modal = document.getElementById('offlineFilesModal');
            const list = document.getElementById('savedFilesList');
            
            if(modal.classList.contains('hidden')) {
                // Show
                modal.classList.remove('hidden');
                const files = JSON.parse(localStorage.getItem('fahim_files') || '[]');
                
                if(files.length === 0) {
                    list.innerHTML = '<p class="text-center text-slate-400 mt-10">لا توجد ملفات محفوظة بعد.</p>';
                } else {
                    list.innerHTML = files.map(f => `
                        <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-primary transition-colors cursor-pointer" onclick="loadSavedAnalysis('${f.id}')">
                            <div>
                                <h4 class="font-bold text-slate-700 dark:text-slate-200">${f.title}</h4>
                                <span class="text-xs text-slate-400">${f.date} • ${f.lang === 'ar' ? 'عربي' : 'English'}</span>
                            </div>
                            <div class="text-primary dark:text-blue-400"><i class="fa-solid fa-chevron-left"></i></div>
                        </div>
                    `).join('');
                }
            } else {
                modal.classList.add('hidden');
            }
        }

        function loadSavedAnalysis(id) {
            const files = JSON.parse(localStorage.getItem('fahim_files') || '[]');
            const record = files.find(f => f.id === id);
            
            if(record) {
                document.getElementById('offlineFilesModal').classList.add('hidden');
                document.getElementById('uploadSection').classList.add('hidden');
                
                // Set UI state
                detectedLang = record.lang;
                document.documentElement.dir = detectedLang === 'ar' ? 'rtl' : 'ltr';
                currentBookTitle = record.title;
                currentAnalysis = record.data;
                
                renderResults(record.data);
                
                // Hide PDF Viewer since we don't store the PDF blob in localStorage (too big)
                document.getElementById('leftPanel').classList.add('panel-closed');
                document.getElementById('resizer').classList.add('opacity-0', 'pointer-events-none');
            }
        }

        function downloadAllZip() {
            if(!currentAnalysis) return;
            
            const zip = new JSZip();
            const folderName = currentBookTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const folder = zip.folder(folderName);
            
            // 1. Text Summary
            const textContent = `
            Title: ${currentBookTitle}
            Summary: ${currentAnalysis.summary}
            ----------------
            Key Points:
            ${currentAnalysis.key_points.join('\n- ')}
            ----------------
            Definitions:
            ${currentAnalysis.definitions.map(d => `${d.term}: ${d.definition}`).join('\n')}
            `;
            folder.file("summary.txt", textContent);
            
            // 2. JSON Data
            folder.file("analysis_data.json", JSON.stringify(currentAnalysis, null, 2));
            
            // 3. Audio (if generated)
            const audioSrc = document.getElementById('audioPlayer').src;
            if(audioSrc && audioSrc.startsWith('blob:')) {
                // Fetch blob data
                fetch(audioSrc).then(r => r.blob()).then(blob => {
                    folder.file("audio_summary.wav", blob);
                    generateZip(zip);
                });
            } else {
                generateZip(zip);
            }
        }

        function generateZip(zip) {
            zip.generateAsync({type:"blob"}).then(function(content) {
                saveAs(content, `${currentBookTitle}_Analysis.zip`);
            });
        }

        // --- Theme System ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const sysTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && sysTheme)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            document.getElementById('themeToggle').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                location.reload(); 
            });
        }

        // --- Splitter Logic ---
        function initSplitter() {
            const resizer = document.getElementById('resizer');
            const leftPanel = document.getElementById('leftPanel');
            let isResizing = false;
            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                leftPanel.style.userSelect = 'none';
                resizer.style.backgroundColor = '#3b82f6';
            });
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const containerWidth = document.body.clientWidth;
                let newLeftWidth = (e.clientX / containerWidth) * 100;
                if(newLeftWidth < 20) newLeftWidth = 20;
                if(newLeftWidth > 70) newLeftWidth = 70;
                leftPanel.style.flex = `0 0 ${newLeftWidth}%`;
            });
            document.addEventListener('mouseup', () => {
                if(isResizing) {
                    isResizing = false;
                    document.body.style.cursor = 'default';
                    leftPanel.style.userSelect = 'auto';
                    resizer.style.backgroundColor = '';
                }
            });
        }

        // --- Toggle PDF Viewer ---
        function togglePdfViewer() {
            const leftPanel = document.getElementById('leftPanel');
            const resizer = document.getElementById('resizer');
            if (leftPanel.classList.contains('panel-closed')) {
                leftPanel.classList.remove('panel-closed');
                resizer.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                leftPanel.classList.add('panel-closed');
                resizer.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        // --- Reset Logic ---
        function goHome() {
            document.getElementById('resultsDashboard').classList.add('hidden');
            document.getElementById('researchResultsDashboard').classList.add('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('pdfToolbar').classList.add('hidden');
            document.getElementById('the-canvas').classList.add('hidden');
            
            // Reset to Book Mode default
            switchMode('book');
            
            const leftPanel = document.getElementById('leftPanel');
            const resizer = document.getElementById('resizer');
            if (leftPanel.classList.contains('panel-closed')) {
                leftPanel.classList.remove('panel-closed');
                resizer.classList.remove('opacity-0', 'pointer-events-none');
            }
            document.getElementById('fileInput').value = '';
            document.getElementById('fileName').textContent = 'اختر ملف PDF';
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('researchInput').value = '';
            pdfDoc = null;
            pageNum = 1;
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                canvas.width = 0; canvas.height = 0;
            }
            currentAnalysis = null;
        }

        // --- PDF Viewer (Standard) ---
        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(function(page) {
                const viewport = page.getViewport({scale: scale});
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                const renderContext = { canvasContext: ctx, viewport: viewport };
                const renderTask = page.render(renderContext);
                renderTask.promise.then(function() {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
            document.getElementById('pageInfo').textContent = `${num} / ${pdfDoc.numPages}`;
        }
        function queueRenderPage(num) {
            if (pageRendering) pageNumPending = num;
            else renderPage(num);
        }
        function prevPage() { if (pageNum <= 1) return; pageNum--; queueRenderPage(pageNum); }
        function nextPage() { if (pageNum >= pdfDoc.numPages) return; pageNum++; queueRenderPage(pageNum); }
        function zoomIn() { scale += 0.2; document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + "%"; renderPage(pageNum); }
        function zoomOut() { if(scale <= 0.4) return; scale -= 0.2; document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + "%"; renderPage(pageNum); }

        // --- Analysis Logic ---
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file) {
                document.getElementById('fileName').textContent = file.name;
                currentBookTitle = file.name.split('.')[0];
                document.getElementById('startBtn').classList.remove('hidden');
                const reader = new FileReader();
                reader.onload = function(ev) {
                    const typedarray = new Uint8Array(ev.target.result);
                    pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                        pdfDoc = pdf;
                        document.getElementById('uploadPlaceholder').classList.add('hidden');
                        document.getElementById('pdfToolbar').classList.remove('hidden');
                        document.getElementById('the-canvas').classList.remove('hidden');
                        renderPage(pageNum);
                    });
                };
                reader.readAsArrayBuffer(file);
            }
        });

        async function extractText(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = "";
            const maxPages = Math.min(pdf.numPages, 40); 
            for (let i = 1; i <= maxPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + "\n";
            }
            return fullText;
        }

        async function startAnalysis() {
            if(!API_KEY) {
                document.getElementById('settingsModal').classList.remove('hidden');
                return;
            }
            const file = fileInput.files[0];
            if(!file) return;

            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
            document.getElementById('uploadSection').classList.add('hidden');

            try {
                // 1. Read & Detect
                const text = await extractText(file);
                const isArabic = detectLanguage(text);
                const langPrompt = isArabic ? "ARABIC" : "ENGLISH";

                // 2. Updated Prompt for Auto-Detection
                const SYSTEM_PROMPT = `
                You are "Fahim Afandi", an elite AI book analyst.
                The book is detected to be in: ${langPrompt}.
                
                IMPORTANT: ALL OUTPUT MUST BE IN ${langPrompt} LANGUAGE ONLY.
                Do not mix languages.
                
                Analyze the text and return valid JSON with exact structure:
                {
                    "summary": "Detailed comprehensive summary",
                    "definitions": [ {"term": "Term", "definition": "Def"} ],
                    "key_points": [ "Point 1", "Point 2" ],
                    "chapters": [ {"title": "Ch1", "summary": "Sum", "lessons": "Less"} ],
                    "headings_qa": [ {"question": "Derived Q?", "answer": "Detailed Answer"} ],
                    "mind_map_mermaid": "graph TD; A-->B;",
                    "audio_summary_script": "Natural script for narration...",
                    "quiz": [ {"question": "Q?", "options": ["A","B"], "correct_index": 0} ]
                }
                `;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: SYSTEM_PROMPT + "\n\nBOOK TEXT START:\n" + text.substring(0, 60000) }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                if(!data.candidates) throw new Error("API Error");
                
                const resultJSON = JSON.parse(data.candidates[0].content.parts[0].text);
                
                // Store results
                currentAnalysis = resultJSON;
                saveAnalysisLocally(resultJSON, currentBookTitle);
                
                renderResults(resultJSON);

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
                document.getElementById('uploadSection').classList.remove('hidden');
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
            }
        }

        function renderResults(data) {
            const dashboard = document.getElementById('resultsDashboard');
            dashboard.classList.remove('hidden');
            document.getElementById('summaryContent').textContent = data.summary;
            document.getElementById('definitionsContent').innerHTML = data.definitions.map(d => `
                <div class="bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg border border-amber-100 dark:border-amber-800">
                    <span class="font-bold text-accent dark:text-amber-400 block">${d.term}</span>
                    <span class="text-sm text-slate-600 dark:text-slate-300">${d.definition}</span>
                </div>
            `).join('');
            document.getElementById('pointsContent').innerHTML = data.key_points.map(p => `
                <li class="flex items-start gap-3 p-3 rounded-lg bg-white dark:bg-darkcard border border-slate-100 dark:border-slate-700">
                    <i class="fa-solid fa-check text-green-500 mt-1"></i>
                    <span class="text-slate-700 dark:text-slate-300">${p}</span>
                </li>
            `).join('');
            document.getElementById('chaptersContent').innerHTML = data.chapters.map(c => `
                <div class="border-b border-slate-100 dark:border-slate-700 pb-4 last:border-0">
                    <h4 class="font-bold text-primary dark:text-blue-400 text-lg mb-1">${c.title}</h4>
                    <p class="text-slate-600 dark:text-slate-300 text-sm mb-2">${c.summary}</p>
                    <div class="text-xs text-slate-400 bg-slate-100 dark:bg-slate-800 inline-block px-2 py-1 rounded">
                        <i class="fa-solid fa-lightbulb text-yellow-500"></i> ${c.lessons}
                    </div>
                </div>
            `).join('');
            const qaContainer = document.getElementById('headingsQaContent');
            if(data.headings_qa && data.headings_qa.length > 0) {
                qaContainer.innerHTML = data.headings_qa.map(item => `
                    <div class="bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <h3 class="font-bold text-lg text-primary dark:text-blue-300 mb-3 flex items-start gap-2">
                            <i class="fa-solid fa-circle-question mt-1 opacity-75"></i> ${item.question}
                        </h3>
                        <div class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed pl-6 border-r-2 border-teal-100 dark:border-teal-900 pr-4 text-justify">${item.answer}</div>
                    </div>
                `).join('');
            } else {
                qaContainer.innerHTML = '<p class="text-slate-400 text-center text-sm">No Q&A generated.</p>';
            }
            const mermaidDiv = document.getElementById('mindmapContainer');
            mermaidDiv.innerHTML = `<div class="mermaid">${data.mind_map_mermaid}</div>`;
            mermaid.init(undefined, document.querySelectorAll('.mermaid'));
            document.getElementById('audioScriptContent').textContent = data.audio_summary_script;
            window.currentAudioScript = data.audio_summary_script;
            document.getElementById('quizContent').innerHTML = data.quiz.map((q, i) => `
                <div class="bg-white dark:bg-darkcard p-5 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm quiz-card" data-correct="${q.correct_index}">
                    <p class="font-bold text-base mb-3 text-secondary dark:text-slate-200"><span class="text-red-500">Q${i+1}.</span> ${q.question}</p>
                    <div class="space-y-2">
                        ${q.options.map((opt, optIdx) => `
                            <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 dark:border-slate-600 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                <input type="radio" name="q${i}" value="${optIdx}" class="w-4 h-4 text-primary">
                                <span class="text-slate-700 dark:text-slate-300 text-sm">${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="feedback mt-2 hidden font-bold text-sm"></div>
                </div>
            `).join('');
        }

        async function generateAudio() {
            if(!window.currentAudioScript) return;
            const btn = document.getElementById('generateAudioBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Generating...';
            btn.disabled = true;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: window.currentAudioScript }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Zephyr" } } }
                        }
                    })
                });
                const data = await response.json();
                const audioBase64 = data.candidates[0].content.parts[0].inlineData.data;
                const binary = atob(audioBase64);
                const array = new Uint8Array(binary.length).map((_, i) => binary.charCodeAt(i));
                const blob = new Blob([array], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                const player = document.getElementById('audioPlayer');
                player.src = url;
                document.getElementById('downloadAudioBtn').href = url;
                document.getElementById('audioPlayerContainer').classList.remove('hidden');
                btn.classList.add('hidden');
            } catch (e) {
                console.error(e);
                alert("Audio Generation Failed");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function checkQuiz() {
            document.querySelectorAll('.quiz-card').forEach(card => {
                const correct = parseInt(card.dataset.correct);
                const selected = card.querySelector('input:checked');
                const feedback = card.querySelector('.feedback');
                feedback.classList.remove('hidden', 'text-green-600', 'text-red-600');
                if(!selected) {
                    feedback.textContent = "Please select an answer";
                    feedback.classList.add('text-slate-400');
                    return;
                }
                if(parseInt(selected.value) === correct) {
                    feedback.textContent = "✅ Correct!";
                    feedback.classList.add('text-green-600');
                    selected.parentElement.classList.add('bg-green-50', 'dark:bg-green-900/30', 'border-green-200', 'dark:border-green-800');
                } else {
                    feedback.textContent = "❌ Incorrect";
                    feedback.classList.add('text-red-600');
                    selected.parentElement.classList.add('bg-red-50', 'dark:bg-red-900/30', 'border-red-200', 'dark:border-red-800');
                }
            });
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) {
                API_KEY = key;
                localStorage.setItem('faheem_api_key', key);
                document.getElementById('settingsModal').classList.add('hidden');
                alert("Settings Saved.");
            }
        }
    </script>
</body>
</html>
